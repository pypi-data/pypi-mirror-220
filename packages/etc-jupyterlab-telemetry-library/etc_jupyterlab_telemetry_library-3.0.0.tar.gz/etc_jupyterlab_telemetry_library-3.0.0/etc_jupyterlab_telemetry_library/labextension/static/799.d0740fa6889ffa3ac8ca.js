"use strict";(self.webpackChunk_educational_technology_collective_etc_jupyterlab_telemetry_library=self.webpackChunk_educational_technology_collective_etc_jupyterlab_telemetry_library||[]).push([[799],{799:(e,o,t)=>{t.r(o),t.d(o,{IETCJupyterLabTelemetryLibraryFactory:()=>w,default:()=>S});var n=t(861),i=t(930),s=t(987),l=t(790);async function d(e="",o={}){const t=l.ServerConnection.makeSettings(),n=s.URLExt.join(t.baseUrl,"etc-jupyterlab-telemetry-library",e);let i;try{i=await l.ServerConnection.makeRequest(n,o,t)}catch(e){throw new l.ServerConnection.NetworkError(e)}let d=await i.text();if(d.length>0)try{d=JSON.parse(d)}catch(e){console.log("Not a JSON response body.",i)}if(!i.ok)throw new l.ServerConnection.ResponseError(i,d.message||d);return d}var a=t(901);class c{constructor({notebookPanel:e,config:o}){this.notebookClipboardEvent=new r({notebookPanel:e,config:o}),this.notebookVisibilityEvent=new b({notebookPanel:e,config:o}),this.notebookCloseEvent=new _({notebookPanel:e,config:o}),this.notebookOpenEvent=new p({notebookPanel:e,config:o}),this.notebookSaveEvent=new k({notebookPanel:e,config:o}),this.cellExecutionEvent=new v({notebookPanel:e,config:o}),this.cellErrorEvent=new y({notebookPanel:e,config:o}),this.notebookScrollEvent=new g({notebookPanel:e,config:o}),this.activeCellChangeEvent=new u({notebookPanel:e,config:o}),this.cellAddEvent=new P({notebookPanel:e,config:o}),this.cellRemoveEvent=new m({notebookPanel:e,config:o})}}class h{constructor(e){this._notebookPanel=e}getVisibleCells(){let e,o,t,n=[],i=this._notebookPanel.content;for(o=0;o<i.widgets.length;o++){e=i.widgets[o];let s=e.node.offsetTop,l=e.node.offsetTop+e.node.offsetHeight,d=i.node.scrollTop;s>i.node.scrollTop+i.node.clientHeight||l<d||(t=e.model.id,n.push({id:t,index:o}))}return n}}class r{constructor({notebookPanel:e,config:o}){this._notebookClipboardCopied=new a.Signal(this),this._notebookClipboardCut=new a.Signal(this),this._notebookClipboardPasted=new a.Signal(this),this._notebookPanel=e,this._notebook=e.content,this.handleCopy=this.handleCopy.bind(this),this.handleCut=this.handleCut.bind(this),this.handlePaste=this.handlePaste.bind(this),e.disposed.connect(this.onDisposed,this),o.notebook_clipboard_event&&(this._notebookPanel.node.addEventListener("copy",this.handleCopy,!1),this._notebookPanel.node.addEventListener("cut",this.handleCut,!1),this._notebookPanel.node.addEventListener("paste",this.handlePaste,!1))}onDisposed(){a.Signal.disconnectAll(this),this._notebookPanel.node.removeEventListener("copy",this.handleCopy,!1),this._notebookPanel.node.removeEventListener("cut",this.handleCut,!1),this._notebookPanel.node.removeEventListener("paste",this.handlePaste,!1)}handleCopy(e){var o;let t=null===(o=document.getSelection())||void 0===o?void 0:o.toString(),n=this._notebookPanel.content.activeCell,i=[{id:null==n?void 0:n.model.id,index:this._notebook.widgets.findIndex((e=>e==n))}];this._notebookClipboardCopied.emit({eventName:"clipboard_copy",cells:i,notebookPanel:this._notebookPanel,selection:t})}handleCut(e){var o;let t=null===(o=document.getSelection())||void 0===o?void 0:o.toString(),n=this._notebookPanel.content.activeCell,i=[{id:null==n?void 0:n.model.id,index:this._notebook.widgets.findIndex((e=>e==n))}];this._notebookClipboardCut.emit({eventName:"clipboard_cut",cells:i,notebookPanel:this._notebookPanel,selection:t})}handlePaste(e){let o=(e.clipboardData||window.clipboardData).getData("text"),t=this._notebookPanel.content.activeCell,n=[{id:null==t?void 0:t.model.id,index:this._notebook.widgets.findIndex((e=>e==t))}];this._notebookClipboardPasted.emit({eventName:"clipboard_paste",cells:n,notebookPanel:this._notebookPanel,selection:o})}get notebookClipboardCopied(){return this._notebookClipboardCopied}get notebookClipboardCut(){return this._notebookClipboardCut}get notebookClipboardPasted(){return this._notebookClipboardPasted}}class b extends h{constructor({notebookPanel:e,config:o}){super(e),this._notebookVisible=new a.Signal(this),this._notebookHidden=new a.Signal(this),this._hiddenProperty="hidden",this._visibilityChange="visibilitychange",this._visibility=!1,this._notebookPanel=e;let t=this._notebook=e.content;this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleFocus=this.handleFocus.bind(this),this.handleBlur=this.handleBlur.bind(this),e.disposed.connect(this.onDisposed,this),o.notebook_visibility_event&&(async()=>{try{await e.revealed,void 0!==document.hidden?(this._hiddenProperty="hidden",this._visibilityChange="visibilitychange"):void 0!==document.msHidden?(this._hiddenProperty="msHidden",this._visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden&&(this._hiddenProperty="webkitHidden",this._visibilityChange="webkitvisibilitychange"),document.addEventListener(this._visibilityChange,this.handleVisibilityChange,!1),t.node.addEventListener("blur",this.handleBlur,!0),t.node.addEventListener("focus",this.handleFocus,!0),window.addEventListener("blur",this.handleBlur,!0),window.addEventListener("focus",this.handleFocus,!0),this.visibility=e.content.isVisible}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this),document.removeEventListener(this._visibilityChange,this.handleVisibilityChange,!1),this._notebook.node.removeEventListener("blur",this.handleBlur,!0),this._notebook.node.removeEventListener("focus",this.handleFocus,!0),window.removeEventListener("blur",this.handleBlur,!0),window.removeEventListener("focus",this.handleFocus,!0)}handleVisibilityChange(e){this.visibility=!document[this._hiddenProperty]&&this._notebook.isVisible}handleBlur(e){e.currentTarget===window&&e.target===window?this.visibility=!1:e.currentTarget===this._notebook.node&&(this.visibility=this._notebook.isVisible)}handleFocus(e){this.visibility=this._notebook.isVisible}set visibility(e){if(this._visibility!=e){this._visibility=e;let o=this.getVisibleCells();!0===this._visibility?this._notebookVisible.emit({eventName:"notebook_visible",cells:o,notebookPanel:this._notebookPanel}):!1===this._visibility&&this._notebookHidden.emit({eventName:"notebook_hidden",cells:o,notebookPanel:this._notebookPanel})}}get notebookVisible(){return this._notebookVisible}get notebookHidden(){return this._notebookHidden}}class _{constructor({notebookPanel:e,config:o}){this._notebookClosed=new a.Signal(this),this._notebookPanel=e,this._notebook=e.content,o.notebook_close_event&&(async()=>{try{await e.revealed,e.disposed.connect(this.onNotebookDisposed,this),e.disposed.connect(this.onDisposed,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onNotebookDisposed(){let e=this._notebook.widgets.map(((e,o)=>({id:e.model.id,index:o})));this._notebookClosed.emit({eventName:"close_notebook",cells:e,notebookPanel:this._notebookPanel})}get notebookClosed(){return this._notebookClosed}}class k{constructor({notebookPanel:e,config:o}){this._notebookSaved=new a.Signal(this),this._notebookPanel=e,e.disposed.connect(this.onDisposed,this),o.notebook_save_event&&(async()=>{try{await e.revealed,e.context.saveState.connect(this.onSaveState,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onSaveState(e,o){let t,n,i;if(o.match("completed")){for(n=[],i=0;i<this._notebookPanel.content.widgets.length;i++)t=this._notebookPanel.content.widgets[i],this._notebookPanel.content.isSelectedOrActive(t)&&n.push({id:t.model.id,index:i});this._notebookSaved.emit({eventName:"save_notebook",cells:n,notebookPanel:this._notebookPanel})}}get notebookSaved(){return this._notebookSaved}}class v{constructor({notebookPanel:e,config:o}){this._cellExecuted=new a.Signal(this),this._notebookPanel=e,this._notebook=e.content,e.disposed.connect(this.onDisposed,this),o.notebook_cell_execution_event&&(async()=>{try{await e.revealed,n.NotebookActions.executed.connect(this.onExecuted,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onExecuted(e,o){if(o.notebook.model===this._notebook.model){let e=[{id:o.cell.model.id,index:this._notebook.widgets.findIndex((e=>e==o.cell))}];this._cellExecuted.emit({eventName:"cell_executed",cells:e,notebookPanel:this._notebookPanel})}}get cellExecuted(){return this._cellExecuted}}class g extends h{constructor({notebookPanel:e,config:o}){super(e),this._notebookScrolled=new a.Signal(this),this._notebookPanel=e,this._timeout=0,this.onScrolled=this.onScrolled.bind(this),e.disposed.connect(this.onDisposed,this),o.notebook_scroll_event&&(async()=>{try{await e.revealed,e.content.node.addEventListener("scroll",this.onScrolled,!1)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onScrolled(e){e.stopPropagation(),clearTimeout(this._timeout),this._timeout=setTimeout((()=>{let e=this.getVisibleCells();this._notebookScrolled.emit({eventName:"scroll",cells:e,notebookPanel:this._notebookPanel})}),1e3)}get notebookScrolled(){return this._notebookScrolled}}class u{constructor({notebookPanel:e,config:o}){this._activeCellChanged=new a.Signal(this),this._notebookPanel=e,this._notebook=e.content,e.disposed.connect(this.onDisposed,this),o.notebook_active_cell_change_event&&(async()=>{try{await e.revealed,e.content.activeCellChanged.connect(this.onActiveCellChanged,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onActiveCellChanged(e,o){if(this._notebook.widgets.length>1){let e=[{id:null==o?void 0:o.model.id,index:this._notebook.widgets.findIndex((e=>e==o))}];this._activeCellChanged.emit({eventName:"active_cell_changed",cells:e,notebookPanel:this._notebookPanel})}}get activeCellChanged(){return this._activeCellChanged}}class p{constructor({notebookPanel:e,config:o}){this._notebookOpened=new a.Signal(this),this._once=!1,this._notebookPanel=e,this._notebook=e.content,e.disposed.connect(this.onDisposed,this),o.notebook_open_event&&(this._once||(async()=>{try{await e.revealed,await this.emitNotebookOpened()}catch(e){console.error(e)}})())}onDisposed(){a.Signal.disconnectAll(this)}async emitNotebookOpened(){let e=this._notebook.widgets.map(((e,o)=>({id:e.model.id,index:o})));this._notebookOpened.emit({eventName:"open_notebook",cells:e,notebookPanel:this._notebookPanel,environ:await d("environ")}),this._once=!0}get notebookOpened(){return this._notebookOpened}}class P{constructor({notebookPanel:e,config:o}){this._cellAdded=new a.Signal(this),this._notebookPanel=e,e.disposed.connect(this.onDisposed,this),o.notebook_cell_add_event&&(async()=>{var o;try{await e.revealed,null===(o=e.content.model)||void 0===o||o.cells.changed.connect(this.onCellsChanged,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onCellsChanged(e,o){if("add"==o.type){let e=[{id:o.newValues[0].id,index:o.newIndex}];this._cellAdded.emit({eventName:"add_cell",cells:e,notebookPanel:this._notebookPanel})}}get cellAdded(){return this._cellAdded}}class m{constructor({notebookPanel:e,config:o}){this._cellRemoved=new a.Signal(this),this._notebookPanel=e,e.disposed.connect(this.onDisposed,this),o.notebook_cell_remove_event&&(async()=>{var o;try{await e.revealed,null===(o=e.content.model)||void 0===o||o.cells.changed.connect(this.onCellsChanged,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onCellsChanged(e,o){if("remove"==o.type){let e=[{id:o.oldValues[0].id,index:o.oldIndex}];this._cellRemoved.emit({eventName:"remove_cell",cells:e,notebookPanel:this._notebookPanel})}}get cellRemoved(){return this._cellRemoved}}class y{constructor({notebookPanel:e,config:o}){this._cellErrored=new a.Signal(this),this._notebookPanel=e,e.disposed.connect(this.onDisposed,this),o.notebook_cell_error_event&&(async()=>{try{await e.revealed,n.NotebookActions.executed.connect(this.onExecuted,this)}catch(e){console.error(e)}})()}onDisposed(){a.Signal.disconnectAll(this)}onExecuted(e,o){if(!o.success||o.error){let e=[{id:o.cell.model.id,index:this._notebookPanel.content.widgets.findIndex((e=>e==o.cell))}];this._cellErrored.emit({eventName:"cell_errored",cells:e,notebookPanel:this._notebookPanel,kernelError:o.error})}}get cellErrored(){return this._cellErrored}}const C="@educational-technology-collective/etc_jupyterlab_telemetry_library:plugin",w=new i.Token(C);class f{constructor({config:e}){this._config=e}create({notebookPanel:e}){return new c({notebookPanel:e,config:this._config})}}const S={id:C,autoStart:!0,provides:w,requires:[n.INotebookTracker],activate:async(e,o)=>{const t=await d("version");console.log(`${C}, ${t}`);const n=await d("config");return new f({config:n})}}}}]);